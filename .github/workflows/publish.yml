name: Publish

on:
  workflow_run:
    workflows: [Test]
    types: [completed]
    branches: [master]

run-name: ${{ github.event.workflow_run.head_commit.message }}

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_exists: ${{ steps.check_tag.outputs.exists }}
      version_changed: ${{ steps.check_version.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if VERSION changed
        id: check_version
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            if git diff --name-only HEAD^ HEAD | grep -q '^VERSION$'; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          else
            # First commit - consider VERSION as changed if it exists
            if [[ -f VERSION ]]; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Get version
        id: version
        if: steps.check_version.outputs.changed == 'true'
        run: |
          VERSION=$(tr -d '[:space:]' < VERSION)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Check if tag exists
        id: check_tag
        if: steps.check_version.outputs.changed == 'true'
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/v${{ steps.version.outputs.version }}$"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.version_changed == 'true' && needs.validate.outputs.tag_exists == 'false'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [[ -n "$LAST_TAG" ]]; then
            COMMITS=$(git log "${LAST_TAG}..HEAD" --pretty=format:"- %s" --no-merges)
            COMPARE_URL="https://github.com/${{ github.repository }}/compare/${LAST_TAG}...v${{ needs.validate.outputs.version }}"
          else
            COMMITS=$(git log --pretty=format:"- %s" --no-merges)
            COMPARE_URL="https://github.com/${{ github.repository }}/commits/v${{ needs.validate.outputs.version }}"
          fi

          {
            echo "changelog<<EOF"
            echo "$COMMITS"
            echo ""
            echo "[Full changelog]($COMPARE_URL)"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ needs.validate.outputs.version }}" -m "Release v${{ needs.validate.outputs.version }}"
          git push origin "v${{ needs.validate.outputs.version }}"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: v${{ needs.validate.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false

      - name: Update Homebrew formula
        uses: dawidd6/action-homebrew-bump-formula@v6
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          tap: designorant/homebrew-tap
          formula: dockroute
          tag: v${{ needs.validate.outputs.version }}

      - name: Auto-merge Homebrew tap PR
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          sleep 5
          PR_NUMBER=$(gh pr list \
            --repo designorant/homebrew-tap \
            --head "bump-dockroute-${{ needs.validate.outputs.version }}" \
            --json number \
            --jq '.[0].number')
          if [[ -n "$PR_NUMBER" ]]; then
            gh pr merge "$PR_NUMBER" \
              --repo designorant/homebrew-tap \
              --squash \
              --subject "chore: bump dockroute to ${{ needs.validate.outputs.version }}" \
              --body ""
          else
            echo "âš  No PR found for bump-dockroute-${{ needs.validate.outputs.version }}"
            exit 1
          fi
